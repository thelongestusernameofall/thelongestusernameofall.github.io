<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,minimum-scale=1,user-scalable=no,minimal-ui"><meta name="renderer" content="webkit"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black"><meta name="format-detection" content="telephone=no,email=no,adress=no"><meta name="theme-color" content="#000000"><meta http-equiv="window-target" content="_top"><title>AFL++ Frida-Mode Scripting | 4x7</title><meta name="description" content="Scripting FRIDA当前支持使用Javascript配置的能力。依靠FRIDA的脚本引擎（支持调试符号和导出表），这比之前使用环境变量配置FRIDA更加方便。 在默认情况下，FRIDA模式会在目标文件(要被fuzz的二进制文件)相同目录下寻找afl.js文件，作为FRIDA的配置文件。若为其他文件名，则可使用AFL_FRIDA_JS_SCRIPT环境变量指定。 在该脚本中，除所有标准的"><meta property="og:type" content="article"><meta property="og:title" content="AFL++ Frida-Mode Scripting"><meta property="og:url" content="http://www.4x7.fun/2022/04/05/AFL-Frida-Mode-Scripting/index.html"><meta property="og:site_name" content="A4x7eq28&#39;Blog"><meta property="og:description" content="Scripting FRIDA当前支持使用Javascript配置的能力。依靠FRIDA的脚本引擎（支持调试符号和导出表），这比之前使用环境变量配置FRIDA更加方便。 在默认情况下，FRIDA模式会在目标文件(要被fuzz的二进制文件)相同目录下寻找afl.js文件，作为FRIDA的配置文件。若为其他文件名，则可使用AFL_FRIDA_JS_SCRIPT环境变量指定。 在该脚本中，除所有标准的"><meta property="og:locale" content="en_US"><meta property="article:published_time" content="2022-04-05T07:56:35.000Z"><meta property="article:modified_time" content="2022-04-20T03:56:28.000Z"><meta property="article:author" content="A4x7eq28"><meta property="article:tag" content="Fuzz"><meta property="article:tag" content="Blind-Fuzz"><meta property="article:tag" content="AFL++"><meta property="article:tag" content="Frida"><meta name="twitter:card" content="summary"><link rel="canonical" href="http://www.4x7.fun/2022/04/05/AFL-Frida-Mode-Scripting/index.html"><link rel="alternate" href="/atom.xml" title="A4x7eq28&#39;Blog" type="application/atom+xml"><link rel="icon" href="/favicon.png" type="image/x-icon"><link rel="stylesheet" href="/css/style.css"><meta name="generator" content="Hexo 6.1.0"></head><body class="main-center" itemscope itemtype="http://schema.org/WebPage"><header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="slimContent"><div class="navbar-header"><div class="profile-block text-center"><a id="avatar" href="https://www.4x7.fun" target="_blank"><img class="img-circle img-rotate" src="/images/avatar.jpg" width="200" height="200"></a><h2 id="name" class="hidden-xs hidden-sm">大和尚</h2><h3 id="title" class="hidden-xs hidden-sm hidden-md">Developer &amp; Security</h3><small id="location" class="text-muted hidden-xs hidden-sm"><i class="icon icon-map-marker"></i> Beijing, China</small></div><div class="search" id="search-form-wrap"><form class="search-form sidebar-form"><div class="input-group"><input type="text" class="search-form-input form-control" placeholder="Search"> <span class="input-group-btn"><button type="submit" class="search-form-submit btn btn-flat" onclick="return!1"><i class="icon icon-search"></i></button></span></div></form><div class="ins-search"><div class="ins-search-mask"></div><div class="ins-search-container"><div class="ins-input-wrapper"><input type="text" class="ins-search-input" placeholder="Type something..." x-webkit-speech> <button type="button" class="close ins-close ins-selectable" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">×</span></button></div><div class="ins-section-wrapper"><div class="ins-section-container"></div></div></div></div></div><button class="navbar-toggle collapsed" type="button" data-toggle="collapse" data-target="#main-navbar" aria-controls="main-navbar" aria-expanded="false"><span class="sr-only">Toggle navigation</span> <span class="icon-bar"></span> <span class="icon-bar"></span> <span class="icon-bar"></span></button></div><nav id="main-navbar" class="collapse navbar-collapse" itemscope itemtype="http://schema.org/SiteNavigationElement" role="navigation"><ul class="nav navbar-nav main-nav"><li class="menu-item menu-item-home"><a href="/."><i class="icon icon-home-fill"></i> <span class="menu-title">Home</span></a></li><li class="menu-item menu-item-archives"><a href="/archives"><i class="icon icon-archives-fill"></i> <span class="menu-title">Archives</span></a></li><li class="menu-item menu-item-categories"><a href="/categories"><i class="icon icon-folder"></i> <span class="menu-title">Categories</span></a></li><li class="menu-item menu-item-tags"><a href="/tags"><i class="icon icon-tags"></i> <span class="menu-title">Tags</span></a></li><li class="menu-item menu-item-repository"><a href="/repository"><i class="icon icon-project"></i> <span class="menu-title">Repository</span></a></li><li class="menu-item menu-item-links"><a href="/links"><i class="icon icon-friendship"></i> <span class="menu-title">Links</span></a></li><li class="menu-item menu-item-about"><a href="/about"><i class="icon icon-cup-fill"></i> <span class="menu-title">About</span></a></li></ul><ul class="social-links"><li><a href="https://twitter.com/hl4x7eq28" target="_blank" title="Twitter" data-toggle="tooltip" data-placement="top"><i class="icon icon-twitter"></i></a></li><li><a href="/atom.xml" target="_blank" title="Rss" data-toggle="tooltip" data-placement="top"><i class="icon icon-rss"></i></a></li></ul></nav></div></header><aside class="sidebar" itemscope itemtype="http://schema.org/WPSideBar"><div class="slimContent"><div class="widget"><h3 class="widget-title">Board</h3><div class="widget-body"><div id="board"><div class="content"><p>4 x 7 = 28</p></div></div></div></div><div class="widget"><h3 class="widget-title">Categories</h3><div class="widget-body"><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Fuzz/">Fuzz</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Pwn2Own/">Pwn2Own</a><span class="category-list-count">7</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Write-Up/">Write Up</a><span class="category-list-count">7</span></li></ul></div></div><div class="widget"><h3 class="widget-title">Tags</h3><div class="widget-body"><ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/404/" rel="tag">404</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/AFL/" rel="tag">AFL++</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Arbitrary-Write/" rel="tag">Arbitrary Write</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Blind-Fuzz/" rel="tag">Blind-Fuzz</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/FSOP/" rel="tag">FSOP</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Format-String/" rel="tag">Format String</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Format-String-Attack/" rel="tag">Format String Attack</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Frida/" rel="tag">Frida</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Fuzz/" rel="tag">Fuzz</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Heap-Overflow/" rel="tag">Heap Overflow</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/HeapAttack/" rel="tag">HeapAttack</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/House-of-Botcake/" rel="tag">House_of_Botcake</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Integer-Underflow/" rel="tag">Integer Underflow</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Integer-Wraparound/" rel="tag">Integer Wraparound</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/LargeBinAttack/" rel="tag">LargeBinAttack</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Off-By-One/" rel="tag">Off By One</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Stack-Overflow/" rel="tag">Stack Overflow</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/System-Call-Table/" rel="tag">System Call Table</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/T-cache/" rel="tag">T-cache</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Write-After-Free/" rel="tag">Write After Free</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Write-Up/" rel="tag">Write Up</a><span class="tag-list-count">7</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/IO-list-all/" rel="tag">_IO_list_all</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/alarm/" rel="tag">alarm</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/shellcode/" rel="tag">shellcode</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/system-call/" rel="tag">system call</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/tcache/" rel="tag">tcache</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/unsortedbin-attack/" rel="tag">unsortedbin attack</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/x86-32/" rel="tag">x86_32</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/x86-64/" rel="tag">x86_64</a><span class="tag-list-count">1</span></li></ul></div></div><div class="widget"><h3 class="widget-title">Tag Cloud</h3><div class="widget-body tagcloud"><a href="/tags/404/" style="font-size:13px">404</a> <a href="/tags/AFL/" style="font-size:13.33px">AFL++</a> <a href="/tags/Arbitrary-Write/" style="font-size:13px">Arbitrary Write</a> <a href="/tags/Blind-Fuzz/" style="font-size:13.33px">Blind-Fuzz</a> <a href="/tags/FSOP/" style="font-size:13px">FSOP</a> <a href="/tags/Format-String/" style="font-size:13px">Format String</a> <a href="/tags/Format-String-Attack/" style="font-size:13.33px">Format String Attack</a> <a href="/tags/Frida/" style="font-size:13.33px">Frida</a> <a href="/tags/Fuzz/" style="font-size:13.33px">Fuzz</a> <a href="/tags/Heap-Overflow/" style="font-size:13.67px">Heap Overflow</a> <a href="/tags/HeapAttack/" style="font-size:13.67px">HeapAttack</a> <a href="/tags/House-of-Botcake/" style="font-size:13px">House_of_Botcake</a> <a href="/tags/Integer-Underflow/" style="font-size:13px">Integer Underflow</a> <a href="/tags/Integer-Wraparound/" style="font-size:13px">Integer Wraparound</a> <a href="/tags/LargeBinAttack/" style="font-size:13px">LargeBinAttack</a> <a href="/tags/Off-By-One/" style="font-size:13px">Off By One</a> <a href="/tags/Stack-Overflow/" style="font-size:13.67px">Stack Overflow</a> <a href="/tags/System-Call-Table/" style="font-size:13.33px">System Call Table</a> <a href="/tags/T-cache/" style="font-size:13px">T-cache</a> <a href="/tags/Write-After-Free/" style="font-size:13px">Write After Free</a> <a href="/tags/Write-Up/" style="font-size:14px">Write Up</a> <a href="/tags/IO-list-all/" style="font-size:13px">_IO_list_all</a> <a href="/tags/alarm/" style="font-size:13px">alarm</a> <a href="/tags/shellcode/" style="font-size:13px">shellcode</a> <a href="/tags/system-call/" style="font-size:13.33px">system call</a> <a href="/tags/tcache/" style="font-size:13px">tcache</a> <a href="/tags/unsortedbin-attack/" style="font-size:13px">unsortedbin attack</a> <a href="/tags/x86-32/" style="font-size:13px">x86_32</a> <a href="/tags/x86-64/" style="font-size:13px">x86_64</a></div></div><div class="widget"><h3 class="widget-title">Archive</h3><div class="widget-body"><ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/04/">April 2022</a><span class="archive-list-count">11</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/03/">March 2022</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/02/">February 2022</a><span class="archive-list-count">1</span></li></ul></div></div><div class="widget"><h3 class="widget-title">Recent Posts</h3><div class="widget-body"><ul class="recent-post-list list-unstyled no-thumbnail"><li><div class="item-inner"><p class="item-category"><a class="category-link" href="/categories/Write-Up/">Write Up</a></p><p class="item-title"><a href="/2022/04/24/WriteUp-2022DASCTF-Apr-X-FATE-good-luck/" class="title">WriteUp: 2022DASCTF Apr X FATE: good_luck</a></p><p class="item-date"><time datetime="2022-04-24T08:06:34.000Z" itemprop="datePublished">2022-04-24</time></p></div></li><li><div class="item-inner"><p class="item-category"><a class="category-link" href="/categories/Write-Up/">Write Up</a></p><p class="item-title"><a href="/2022/04/20/WriteUp-ciscn-2019-sw-7/" class="title">WriteUp: ciscn_2019_sw_7</a></p><p class="item-date"><time datetime="2022-04-20T05:50:22.000Z" itemprop="datePublished">2022-04-20</time></p></div></li><li><div class="item-inner"><p class="item-category"><a class="category-link" href="/categories/Write-Up/">Write Up</a></p><p class="item-title"><a href="/2022/04/19/WriteUp-Baby-Tcache-ciscn-2019-n-2/" class="title">WriteUp: Baby Tcache (ciscn_2019_n_2)</a></p><p class="item-date"><time datetime="2022-04-18T19:15:03.000Z" itemprop="datePublished">2022-04-19</time></p></div></li><li><div class="item-inner"><p class="item-category"><a class="category-link" href="/categories/Write-Up/">Write Up</a></p><p class="item-title"><a href="/2022/04/18/WriteUp-w0odpeck3r-s-Nest/" class="title">WriteUp: w0odpeck3r&#39;s Nest</a></p><p class="item-date"><time datetime="2022-04-18T10:08:10.000Z" itemprop="datePublished">2022-04-18</time></p></div></li><li><div class="item-inner"><p class="item-category"><a class="category-link" href="/categories/Write-Up/">Write Up</a></p><p class="item-title"><a href="/2022/04/17/WriteUp-SECPROG-calculator/" class="title">WriteUp: SECPROG calculator</a></p><p class="item-date"><time datetime="2022-04-16T18:55:21.000Z" itemprop="datePublished">2022-04-17</time></p></div></li></ul></div></div></div></aside><main class="main" role="main"><div class="content"><article id="post-AFL-Frida-Mode-Scripting" class="article article-type-post" itemscope itemtype="http://schema.org/BlogPosting"><div class="article-header"><h1 class="article-title" itemprop="name">AFL++ Frida-Mode Scripting</h1><div class="article-meta"><span class="article-date"><i class="icon icon-calendar-check"></i> <a href="/2022/04/05/AFL-Frida-Mode-Scripting/" class="article-date"><time datetime="2022-04-05T07:56:35.000Z" itemprop="datePublished">2022-04-05</time> </a></span><span class="article-category"><i class="icon icon-folder"></i> <a class="article-category-link" href="/categories/Fuzz/">Fuzz</a> </span><span class="article-tag"><i class="icon icon-tags"></i> <a class="article-tag-link-link" href="/tags/AFL/" rel="tag">AFL++</a>, <a class="article-tag-link-link" href="/tags/Blind-Fuzz/" rel="tag">Blind-Fuzz</a>, <a class="article-tag-link-link" href="/tags/Frida/" rel="tag">Frida</a>, <a class="article-tag-link-link" href="/tags/Fuzz/" rel="tag">Fuzz</a> </span><span class="article-read hidden-xs"><i class="icon icon-eye-fill" aria-hidden="true"></i> <span id="busuanzi_container_page_pv"><span id="busuanzi_value_page_pv">0</span> </span></span><span class="post-comment"><i class="icon icon-comment"></i> <a href="/2022/04/05/AFL-Frida-Mode-Scripting/#comments" class="article-comment-link">Comments</a></span></div></div><div class="article-entry marked-body" itemprop="articleBody"><h1 id="scripting"><a class="markdownIt-Anchor" href="#scripting"></a> Scripting</h1><p>FRIDA当前支持使用Javascript配置的能力。依靠FRIDA的脚本引擎（支持调试符号和导出表），这比之前使用环境变量配置FRIDA更加方便。</p><p>在默认情况下，FRIDA模式会在目标文件(要被fuzz的二进制文件)相同目录下寻找<code>afl.js</code>文件，作为FRIDA的配置文件。若为其他文件名，则可使用<code>AFL_FRIDA_JS_SCRIPT</code>环境变量指定。</p><p>在该脚本中，除所有标准的<a target="_blank" rel="noopener" href="https://frida.re/docs/javascript-api/">frida api函数</a>外，还另外添加了一些功能函数用以与FRIDA mode自身交互。这些额外的函数可以通过全局变量<code>Afl</code>来访问， 例如 <code>Afl.print(&quot;Hello world&quot;);</code> 取代 <code>console.log(&quot;Hello World&quot;);</code></p><p>在使用中若需要调试，则使用环境变量<code>AFL_DEBUG_CHILD=1</code>.</p><h2 id="example"><a class="markdownIt-Anchor" href="#example"></a> Example</h2><p>在有符号的二进制中，用户往往更喜欢用符号指定函数地址（例如入口函数或者persistent fuzz的地址）。</p><p>下面的例子使用了API<br><a target="_blank" rel="noopener" href="https://frida.re/docs/javascript-api/#debugsymbol"><code>DebugSymbol.fromName()</code></a>.<br>和<br><a target="_blank" rel="noopener" href="https://frida.re/docs/javascript-api/#module"><code>Module.getExportByName()</code></a>.</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Use Afl.print instead of console.log */</span></span><br><span class="line"><span class="title class_">Afl</span>.<span class="title function_">print</span>(<span class="string">&#x27;******************&#x27;</span>);</span><br><span class="line"><span class="title class_">Afl</span>.<span class="title function_">print</span>(<span class="string">&#x27;* AFL FRIDA MODE *&#x27;</span>);</span><br><span class="line"><span class="title class_">Afl</span>.<span class="title function_">print</span>(<span class="string">&#x27;******************&#x27;</span>);</span><br><span class="line"><span class="title class_">Afl</span>.<span class="title function_">print</span>(<span class="string">&#x27;&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Print some useful diagnostics stuff */</span></span><br><span class="line"><span class="title class_">Afl</span>.<span class="title function_">print</span>(<span class="string">`PID: <span class="subst">$&#123;Process.id&#125;</span>`</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">new</span> <span class="title class_">ModuleMap</span>().<span class="title function_">values</span>().<span class="title function_">forEach</span>(<span class="function"><span class="params">m</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="title class_">Afl</span>.<span class="title function_">print</span>(<span class="string">`<span class="subst">$&#123;m.base&#125;</span>-<span class="subst">$&#123;m.base.add(m.size)&#125;</span> <span class="subst">$&#123;m.name&#125;</span>`</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Configure entry-point, persistence etc. This will be what most</span></span><br><span class="line"><span class="comment"> * people want to do.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">const</span> persistent_addr = <span class="title class_">DebugSymbol</span>.<span class="title function_">fromName</span>(<span class="string">&#x27;main&#x27;</span>);</span><br><span class="line"><span class="title class_">Afl</span>.<span class="title function_">print</span>(<span class="string">`persistent_addr: <span class="subst">$&#123;persistent_addr.address&#125;</span>`</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (persistent_addr.<span class="property">address</span>.<span class="title function_">equals</span>(<span class="title function_">ptr</span>(<span class="number">0</span>))) &#123;</span><br><span class="line">    <span class="title class_">Afl</span>.<span class="title function_">error</span>(<span class="string">&#x27;Cannot find symbol main&#x27;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> persistent_ret = <span class="title class_">DebugSymbol</span>.<span class="title function_">fromName</span>(<span class="string">&#x27;slow&#x27;</span>);</span><br><span class="line"><span class="title class_">Afl</span>.<span class="title function_">print</span>(<span class="string">`persistent_ret: <span class="subst">$&#123;persistent_ret.address&#125;</span>`</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (persistent_ret.<span class="property">address</span>.<span class="title function_">equals</span>(<span class="title function_">ptr</span>(<span class="number">0</span>))) &#123;</span><br><span class="line">    <span class="title class_">Afl</span>.<span class="title function_">error</span>(<span class="string">&#x27;Cannot find symbol slow&#x27;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title class_">Afl</span>.<span class="title function_">setPersistentAddress</span>(persistent_addr.<span class="property">address</span>);</span><br><span class="line"><span class="title class_">Afl</span>.<span class="title function_">setPersistentReturn</span>(persistent_ret.<span class="property">address</span>);</span><br><span class="line"><span class="title class_">Afl</span>.<span class="title function_">setPersistentCount</span>(<span class="number">1000000</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Control instrumentation, you may want to do this too */</span></span><br><span class="line"><span class="title class_">Afl</span>.<span class="title function_">setInstrumentLibraries</span>();</span><br><span class="line"><span class="keyword">const</span> mod = <span class="title class_">Process</span>.<span class="title function_">findModuleByName</span>(<span class="string">&quot;libc-2.31.so&quot;</span>)</span><br><span class="line"><span class="title class_">Afl</span>.<span class="title function_">addExcludedRange</span>(mod.<span class="property">base</span>, mod.<span class="property">size</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Some useful options to configure logging */</span></span><br><span class="line"><span class="title class_">Afl</span>.<span class="title function_">setStdOut</span>(<span class="string">&quot;/tmp/stdout.txt&quot;</span>);</span><br><span class="line"><span class="title class_">Afl</span>.<span class="title function_">setStdErr</span>(<span class="string">&quot;/tmp/stderr.txt&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Show the address layout. Sometimes helpful */</span></span><br><span class="line"><span class="title class_">Afl</span>.<span class="title function_">setDebugMaps</span>();</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * If you are using these options, then things aren&#x27;t going</span></span><br><span class="line"><span class="comment"> * very well for you.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="title class_">Afl</span>.<span class="title function_">setInstrumentDebugFile</span>(<span class="string">&quot;/tmp/instr.log&quot;</span>);</span><br><span class="line"><span class="title class_">Afl</span>.<span class="title function_">setPrefetchDisable</span>();</span><br><span class="line"><span class="title class_">Afl</span>.<span class="title function_">setInstrumentNoOptimize</span>();</span><br><span class="line"><span class="title class_">Afl</span>.<span class="title function_">setInstrumentEnableTracing</span>();</span><br><span class="line"><span class="title class_">Afl</span>.<span class="title function_">setInstrumentTracingUnique</span>();</span><br><span class="line"><span class="title class_">Afl</span>.<span class="title function_">setStatsFile</span>(<span class="string">&quot;/tmp/stats.txt&quot;</span>);</span><br><span class="line"><span class="title class_">Afl</span>.<span class="title function_">setStatsInterval</span>(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">/* *ALWAYS* call this when you have finished all your configuration */</span></span><br><span class="line"><span class="title class_">Afl</span>.<span class="title function_">done</span>();</span><br><span class="line"><span class="title class_">Afl</span>.<span class="title function_">print</span>(<span class="string">&quot;done&quot;</span>);</span><br></pre></td></tr></table></figure><h2 id="stripped-binaries"><a class="markdownIt-Anchor" href="#stripped-binaries"></a> Stripped binaries</h2><p>下面的例子是处理没符号或者导出表的二进制的情况：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="variable language_">module</span> = <span class="title class_">Process</span>.<span class="title function_">getModuleByName</span>(<span class="string">&#x27;target.exe&#x27;</span>);</span><br><span class="line"><span class="comment">/* Hardcoded offset within the target image */</span></span><br><span class="line"><span class="keyword">const</span> address = <span class="variable language_">module</span>.<span class="property">base</span>.<span class="title function_">add</span>(<span class="number">0xdeadface</span>);</span><br><span class="line"><span class="title class_">Afl</span>.<span class="title function_">setPersistentAddress</span>(address);</span><br></pre></td></tr></table></figure><h2 id="persistent-hook"><a class="markdownIt-Anchor" href="#persistent-hook"></a> Persistent hook</h2><p>Persistent hook可以通过使用一个共享链接库的方式(***.so)的方式实现。示例源码（hook并fuzz<code>LLVMFuzzerTestOneInput</code>函数的例子）可以在Frida_mode/hook目录下找到。在该例子中，使用了如下的代码片段实现Persistent Hook。</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> path = <span class="title class_">Afl</span>.<span class="property">module</span>.<span class="property">path</span>;</span><br><span class="line"><span class="keyword">const</span> dir = path.<span class="title function_">substring</span>(<span class="number">0</span>, path.<span class="title function_">lastIndexOf</span>(<span class="string">&quot;/&quot;</span>));</span><br><span class="line"><span class="keyword">const</span> mod = <span class="title class_">Module</span>.<span class="title function_">load</span>(<span class="string">`<span class="subst">$&#123;dir&#125;</span>/frida_mode/build/hook.so`</span>);</span><br><span class="line"><span class="keyword">const</span> hook = mod.<span class="title function_">getExportByName</span>(<span class="string">&#x27;afl_persistent_hook&#x27;</span>);</span><br><span class="line"><span class="title class_">Afl</span>.<span class="title function_">setPersistentHook</span>(hook);</span><br></pre></td></tr></table></figure><p>Persistent Hook也可以通过FRIDA本身对<code>CModule</code>的支持来实现，该功能依赖于TinyCC。</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> cm = <span class="keyword">new</span> <span class="title class_">CModule</span>(<span class="string">`</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    #include &lt;string.h&gt;</span></span><br><span class="line"><span class="string">    #include &lt;gum/gumdefs.h&gt;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    void afl_persistent_hook(GumCpuContext *regs, uint8_t *input_buf,</span></span><br><span class="line"><span class="string">      uint32_t input_buf_len) &#123;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">      memcpy((void *)regs-&gt;rdi, input_buf, input_buf_len);</span></span><br><span class="line"><span class="string">      regs-&gt;rsi = input_buf_len;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">    `</span>,</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="attr">memcpy</span>: <span class="title class_">Module</span>.<span class="title function_">getExportByName</span>(<span class="literal">null</span>, <span class="string">&#x27;memcpy&#x27;</span>)</span><br><span class="line">    &#125;);</span><br><span class="line"><span class="title class_">Afl</span>.<span class="title function_">setPersistentHook</span>(cm.<span class="property">afl_persistent_hook</span>);</span><br></pre></td></tr></table></figure><h2 id="advanced-persistence"><a class="markdownIt-Anchor" href="#advanced-persistence"></a> Advanced persistence</h2><p>以如下的代码作为（被fuzz）的目标程序源码为例：</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdbool.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">LLVMFuzzerTestOneInput</span><span class="params">(<span class="type">char</span> *buf, <span class="type">int</span> len)</span> &#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (len &lt; <span class="number">1</span>) <span class="keyword">return</span>;</span><br><span class="line">  buf[len] = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// we support three input cases</span></span><br><span class="line">  <span class="keyword">if</span> (buf[<span class="number">0</span>] == <span class="string">&#x27;0&#x27;</span>)</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Looks like a zero to me!\n&quot;</span>);</span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span> (buf[<span class="number">0</span>] == <span class="string">&#x27;1&#x27;</span>)</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Pretty sure that is a one!\n&quot;</span>);</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Neither one or zero? How quaint!\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">run</span><span class="params">(<span class="type">char</span> *file)</span> &#123;</span><br><span class="line"></span><br><span class="line">  <span class="type">int</span>    fd = <span class="number">-1</span>;</span><br><span class="line">  <span class="type">off_t</span>  len;</span><br><span class="line">  <span class="type">char</span> * buf = <span class="literal">NULL</span>;</span><br><span class="line">  <span class="type">size_t</span> n_read;</span><br><span class="line">  <span class="type">int</span>    result = <span class="number">-1</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">do</span> &#123;</span><br><span class="line"></span><br><span class="line">    dprintf(STDERR_FILENO, <span class="string">&quot;Running: %s\n&quot;</span>, file);</span><br><span class="line"></span><br><span class="line">    fd = open(file, O_RDONLY);</span><br><span class="line">    <span class="keyword">if</span> (fd &lt; <span class="number">0</span>) &#123;</span><br><span class="line"></span><br><span class="line">      perror(<span class="string">&quot;open&quot;</span>);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    len = lseek(fd, <span class="number">0</span>, SEEK_END);</span><br><span class="line">    <span class="keyword">if</span> (len &lt; <span class="number">0</span>) &#123;</span><br><span class="line"></span><br><span class="line">      perror(<span class="string">&quot;lseek (SEEK_END)&quot;</span>);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (lseek(fd, <span class="number">0</span>, SEEK_SET) != <span class="number">0</span>) &#123;</span><br><span class="line"></span><br><span class="line">      perror(<span class="string">&quot;lseek (SEEK_SET)&quot;</span>);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    buf = <span class="built_in">malloc</span>(len);</span><br><span class="line">    <span class="keyword">if</span> (buf == <span class="literal">NULL</span>) &#123;</span><br><span class="line"></span><br><span class="line">      perror(<span class="string">&quot;malloc&quot;</span>);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    n_read = read(fd, buf, len);</span><br><span class="line">    <span class="keyword">if</span> (n_read != len) &#123;</span><br><span class="line"></span><br><span class="line">      perror(<span class="string">&quot;read&quot;</span>);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    dprintf(STDERR_FILENO, <span class="string">&quot;Running:    %s: (%zd bytes)\n&quot;</span>, file, n_read);</span><br><span class="line"></span><br><span class="line">    LLVMFuzzerTestOneInput(buf, len);</span><br><span class="line">    dprintf(STDERR_FILENO, <span class="string">&quot;Done:    %s: (%zd bytes)\n&quot;</span>, file, n_read);</span><br><span class="line"></span><br><span class="line">    result = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  &#125; <span class="keyword">while</span> (<span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (buf != <span class="literal">NULL</span>) &#123; <span class="built_in">free</span>(buf); &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (fd != <span class="number">-1</span>) &#123; close(fd); &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">slow</span><span class="params">()</span> &#123;</span><br><span class="line"></span><br><span class="line">  usleep(<span class="number">100000</span>);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> **argv)</span> &#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (argc != <span class="number">2</span>) &#123; <span class="keyword">return</span> <span class="number">1</span>; &#125;</span><br><span class="line">  slow();</span><br><span class="line">  <span class="keyword">return</span> run(argv[<span class="number">1</span>]);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>使用CModule的实现方法，FRIDA模式支持对<strong>任何函数</strong>的替换。如下例：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> slow = <span class="title class_">DebugSymbol</span>.<span class="title function_">fromName</span>(<span class="string">&#x27;slow&#x27;</span>).<span class="property">address</span>;</span><br><span class="line"><span class="title class_">Afl</span>.<span class="title function_">print</span>(<span class="string">`slow: <span class="subst">$&#123;slow&#125;</span>`</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title class_">LLVMFuzzerTestOneInput</span> = <span class="title class_">DebugSymbol</span>.<span class="title function_">fromName</span>(<span class="string">&#x27;LLVMFuzzerTestOneInput&#x27;</span>).<span class="property">address</span>;</span><br><span class="line"><span class="title class_">Afl</span>.<span class="title function_">print</span>(<span class="string">`LLVMFuzzerTestOneInput: <span class="subst">$&#123;LLVMFuzzerTestOneInput&#125;</span>`</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> cm = <span class="keyword">new</span> <span class="title class_">CModule</span>(<span class="string">`</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    extern unsigned char * __afl_fuzz_ptr;</span></span><br><span class="line"><span class="string">    extern unsigned int * __afl_fuzz_len;</span></span><br><span class="line"><span class="string">    extern void LLVMFuzzerTestOneInput(char *buf, int len);</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    void slow(void) &#123;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">      LLVMFuzzerTestOneInput(__afl_fuzz_ptr, *__afl_fuzz_len);</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">    `</span>,</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="title class_">LLVMFuzzerTestOneInput</span>: <span class="title class_">LLVMFuzzerTestOneInput</span>,</span><br><span class="line">        <span class="attr">__afl_fuzz_ptr</span>: <span class="title class_">Afl</span>.<span class="title function_">getAflFuzzPtr</span>(),</span><br><span class="line">        <span class="attr">__afl_fuzz_len</span>: <span class="title class_">Afl</span>.<span class="title function_">getAflFuzzLen</span>()</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line"><span class="title class_">Afl</span>.<span class="title function_">setEntryPoint</span>(cm.<span class="property">slow</span>);</span><br><span class="line"><span class="title class_">Afl</span>.<span class="title function_">setPersistentAddress</span>(cm.<span class="property">slow</span>);</span><br><span class="line"><span class="title class_">Afl</span>.<span class="title function_">setInMemoryFuzzing</span>();</span><br><span class="line"><span class="title class_">Interceptor</span>.<span class="title function_">replace</span>(slow, cm.<span class="property">slow</span>);</span><br><span class="line"><span class="title class_">Afl</span>.<span class="title function_">print</span>(<span class="string">&quot;done&quot;</span>);</span><br><span class="line"><span class="title class_">Afl</span>.<span class="title function_">done</span>();</span><br></pre></td></tr></table></figure><p>在这个例子里，我们将<code>slow</code>函数替换成我们自己的代码。该代码随后被设定为入口地址、及persistent循环的地址。</p><h3 id="replacing-llvmfuzzertestoneinput"><a class="markdownIt-Anchor" href="#replacing-llvmfuzzertestoneinput"></a> Replacing LLVMFuzzerTestOneInput</h3><p>与其他函数类似，函数<code>LLVMFuzzerTestOneInput</code>同样可以被替换。另外，任何被替换的函数都可以调用它本身。在下面的例子中，我们将<code>LLVMFuzzerTestOneInput</code>函数替换成<code>My_LLVMFuzzerTestOneInput</code>函数，并忽视<code>buf</code>和<code>len</code>两个参数；而改为使用<code>__afl_fuzzer_ptr</code>和<code>__afl_fuzz_len</code>。这允许我们在不必hook其他函数的情况下使用in-memory fuzzing。需要注意的是：替换函数和被替换的原函数<em>不能</em>使用同一函数名字，否则在<code>CModule</code>中的<code>C</code>代码将会由于符号名冲突而不能编译。</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title class_">LLVMFuzzerTestOneInput</span> = <span class="title class_">DebugSymbol</span>.<span class="title function_">fromName</span>(<span class="string">&#x27;LLVMFuzzerTestOneInput&#x27;</span>).<span class="property">address</span>;</span><br><span class="line"><span class="title class_">Afl</span>.<span class="title function_">print</span>(<span class="string">`LLVMFuzzerTestOneInput: <span class="subst">$&#123;LLVMFuzzerTestOneInput&#125;</span>`</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> cm = <span class="keyword">new</span> <span class="title class_">CModule</span>(<span class="string">`</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    extern unsigned char * __afl_fuzz_ptr;</span></span><br><span class="line"><span class="string">    extern unsigned int * __afl_fuzz_len;</span></span><br><span class="line"><span class="string">    extern void LLVMFuzzerTestOneInput(char *buf, int len);</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    void My_LLVMFuzzerTestOneInput(char *buf, int len) &#123;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">      LLVMFuzzerTestOneInput(__afl_fuzz_ptr, *__afl_fuzz_len);</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">    `</span>,</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="title class_">LLVMFuzzerTestOneInput</span>: <span class="title class_">LLVMFuzzerTestOneInput</span>,</span><br><span class="line">        <span class="attr">__afl_fuzz_ptr</span>: <span class="title class_">Afl</span>.<span class="title function_">getAflFuzzPtr</span>(),</span><br><span class="line">        <span class="attr">__afl_fuzz_len</span>: <span class="title class_">Afl</span>.<span class="title function_">getAflFuzzLen</span>()</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line"><span class="title class_">Afl</span>.<span class="title function_">setEntryPoint</span>(cm.<span class="property">My_LLVMFuzzerTestOneInput</span>);</span><br><span class="line"><span class="title class_">Afl</span>.<span class="title function_">setPersistentAddress</span>(cm.<span class="property">My_LLVMFuzzerTestOneInput</span>);</span><br><span class="line"><span class="title class_">Afl</span>.<span class="title function_">setInMemoryFuzzing</span>();</span><br><span class="line"><span class="title class_">Interceptor</span>.<span class="title function_">replace</span>(<span class="title class_">LLVMFuzzerTestOneInput</span>, cm.<span class="property">My_LLVMFuzzerTestOneInput</span>);</span><br></pre></td></tr></table></figure><h3 id="hooking-main"><a class="markdownIt-Anchor" href="#hooking-main"></a> Hooking <code>main</code></h3><p>最后，需要注意的是，<code>main</code>函数的Hook是一个特殊情况，这是因为<code>main</code>函数已经被FRIDA引擎自身hook了（至少第一个基本块已经被Stalker编译了）。因此任何如以上例子使用<code>Interceptor.replace</code>对<code>main</code>函数的替换都无效。JS绑定为此提供了<code>setJsMainHook</code>如下例所示：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> main = <span class="title class_">DebugSymbol</span>.<span class="title function_">fromName</span>(<span class="string">&#x27;main&#x27;</span>).<span class="property">address</span>;</span><br><span class="line"><span class="title class_">Afl</span>.<span class="title function_">print</span>(<span class="string">`main: <span class="subst">$&#123;main&#125;</span>`</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title class_">LLVMFuzzerTestOneInput</span> = <span class="title class_">DebugSymbol</span>.<span class="title function_">fromName</span>(<span class="string">&#x27;LLVMFuzzerTestOneInput&#x27;</span>).<span class="property">address</span>;</span><br><span class="line"><span class="title class_">Afl</span>.<span class="title function_">print</span>(<span class="string">`LLVMFuzzerTestOneInput: <span class="subst">$&#123;LLVMFuzzerTestOneInput&#125;</span>`</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> cm = <span class="keyword">new</span> <span class="title class_">CModule</span>(<span class="string">`</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    extern unsigned char * __afl_fuzz_ptr;</span></span><br><span class="line"><span class="string">    extern unsigned int * __afl_fuzz_len;</span></span><br><span class="line"><span class="string">    extern void LLVMFuzzerTestOneInput(char *buf, int len);</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    int main(int argc, char **argv)  &#123;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">      LLVMFuzzerTestOneInput(__afl_fuzz_ptr, *__afl_fuzz_len);</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">    `</span>,</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="title class_">LLVMFuzzerTestOneInput</span>: <span class="title class_">LLVMFuzzerTestOneInput</span>,</span><br><span class="line">        <span class="attr">__afl_fuzz_ptr</span>: <span class="title class_">Afl</span>.<span class="title function_">getAflFuzzPtr</span>(),</span><br><span class="line">        <span class="attr">__afl_fuzz_len</span>: <span class="title class_">Afl</span>.<span class="title function_">getAflFuzzLen</span>()</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line"><span class="title class_">Afl</span>.<span class="title function_">setEntryPoint</span>(cm.<span class="property">main</span>);</span><br><span class="line"><span class="title class_">Afl</span>.<span class="title function_">setPersistentAddress</span>(cm.<span class="property">main</span>);</span><br><span class="line"><span class="title class_">Afl</span>.<span class="title function_">setInMemoryFuzzing</span>();</span><br><span class="line"><span class="title class_">Afl</span>.<span class="title function_">setJsMainHook</span>(cm.<span class="property">main</span>);</span><br></pre></td></tr></table></figure><h3 id="library-fuzzing"><a class="markdownIt-Anchor" href="#library-fuzzing"></a> Library Fuzzing</h3><p>使用FRIDA的<code>Module.load</code>API,可扩展上述例子<code>main</code>函数的能力，使之调用任意函数。从而，当我们需要Fuzz一个动态链接库（而非可执行程序）时，可使用一个代理可执行程序作为入口。</p><h2 id="patching"><a class="markdownIt-Anchor" href="#patching"></a> Patching</h2><p>以如下测试代码为例：</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">   american fuzzy lop++ - a trivial program to test the build</span></span><br><span class="line"><span class="comment">   --------------------------------------------------------</span></span><br><span class="line"><span class="comment">   Originally written by Michal Zalewski</span></span><br><span class="line"><span class="comment">   Copyright 2014 Google Inc. All rights reserved.</span></span><br><span class="line"><span class="comment">   Copyright 2019-2022 AFLplusplus Project. All rights reserved.</span></span><br><span class="line"><span class="comment">   Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span></span><br><span class="line"><span class="comment">   you may not use this file except in compliance with the License.</span></span><br><span class="line"><span class="comment">   You may obtain a copy of the License at:</span></span><br><span class="line"><span class="comment">     https://www.apache.org/licenses/LICENSE-2.0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdbool.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdint.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">const</span> <span class="type">uint32_t</span> crc32_tab[] = &#123;</span><br><span class="line">    <span class="number">0x00000000</span>, <span class="number">0x77073096</span>, <span class="number">0xee0e612c</span>, <span class="number">0x990951ba</span>, <span class="number">0x076dc419</span>, <span class="number">0x706af48f</span>,</span><br><span class="line"></span><br><span class="line">  ...</span><br><span class="line"></span><br><span class="line">    <span class="number">0xb40bbe37</span>, <span class="number">0xc30c8ea1</span>, <span class="number">0x5a05df1b</span>, <span class="number">0x2d02ef8d</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">uint32_t</span></span><br><span class="line"><span class="title function_">crc32</span><span class="params">(<span class="type">const</span> <span class="type">void</span> *buf, <span class="type">size_t</span> size)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">const</span> <span class="type">uint8_t</span> *p = buf;</span><br><span class="line">    <span class="type">uint32_t</span> crc;</span><br><span class="line">    crc = ~<span class="number">0U</span>;</span><br><span class="line">    <span class="keyword">while</span> (size--)</span><br><span class="line">        crc = crc32_tab[(crc ^ *p++) &amp; <span class="number">0xFF</span>] ^ (crc &gt;&gt; <span class="number">8</span>);</span><br><span class="line">    <span class="keyword">return</span> crc ^ ~<span class="number">0U</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Don&#x27;t you hate those contrived examples which CRC their data. We can use</span></span><br><span class="line"><span class="comment"> * FRIDA to patch this function out and always return success. Otherwise, we</span></span><br><span class="line"><span class="comment"> * could change it to actually correct the checksum.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">crc32_check</span> <span class="params">(<span class="type">char</span> * buf, <span class="type">int</span> len)</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (len &lt; <span class="keyword">sizeof</span>(<span class="type">uint32_t</span>)) &#123; <span class="keyword">return</span> <span class="number">0</span>; &#125;</span><br><span class="line">  <span class="type">uint32_t</span> expected = *(<span class="type">uint32_t</span> *)&amp;buf[len - <span class="keyword">sizeof</span>(<span class="type">uint32_t</span>)];</span><br><span class="line">  <span class="type">uint32_t</span> calculated = crc32(buf, len - <span class="keyword">sizeof</span>(<span class="type">uint32_t</span>));</span><br><span class="line">  <span class="keyword">return</span> expected == calculated;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * So you&#x27;ve found a really boring bug in an earlier campaign which results in</span></span><br><span class="line"><span class="comment"> * a NULL dereference or something like that. That bug can get in the way,</span></span><br><span class="line"><span class="comment"> * causing the persistent loop to exit whenever it is triggered, and can also</span></span><br><span class="line"><span class="comment"> * cloud your output unnecessarily. Again, we can use FRIDA to patch it out.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">some_boring_bug</span><span class="params">(<span class="type">char</span> c)</span> &#123;</span><br><span class="line">  <span class="keyword">switch</span> (c) &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">&#x27;A&#x27;</span>..<span class="number">.&#x27;</span>Z<span class="number">&#x27;</span>:</span><br><span class="line">    <span class="keyword">case</span> <span class="string">&#x27;a&#x27;</span>..<span class="number">.&#x27;</span>z<span class="number">&#x27;</span>:</span><br><span class="line">      __builtin_trap();</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">LLVMFuzzerTestOneInput</span><span class="params">(<span class="type">char</span> *buf, <span class="type">int</span> len)</span> &#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!crc32_check(buf, len)) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">  some_boring_bug(buf[<span class="number">0</span>]);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (buf[<span class="number">0</span>] == <span class="string">&#x27;0&#x27;</span>) &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Looks like a zero to me!\n&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span> (buf[<span class="number">0</span>] == <span class="string">&#x27;1&#x27;</span>) &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Pretty sure that is a one!\n&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span> (buf[<span class="number">0</span>] == <span class="string">&#x27;2&#x27;</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (buf[<span class="number">1</span>] == <span class="string">&#x27;3&#x27;</span>) &#123;</span><br><span class="line">      <span class="keyword">if</span> (buf[<span class="number">2</span>] == <span class="string">&#x27;4&#x27;</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Oh we, weren&#x27;t expecting that!&quot;</span>);</span><br><span class="line">        __builtin_trap();</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Neither one or zero? How quaint!\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> **argv)</span> &#123;</span><br><span class="line"></span><br><span class="line">  <span class="type">int</span>    fd = <span class="number">-1</span>;</span><br><span class="line">  <span class="type">off_t</span>  len;</span><br><span class="line">  <span class="type">char</span> * buf = <span class="literal">NULL</span>;</span><br><span class="line">  <span class="type">size_t</span> n_read;</span><br><span class="line">  <span class="type">int</span>    result = <span class="number">-1</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (argc != <span class="number">2</span>) &#123; <span class="keyword">return</span> <span class="number">1</span>; &#125;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Running: %s\n&quot;</span>, argv[<span class="number">1</span>]);</span><br><span class="line"></span><br><span class="line">  fd = open(argv[<span class="number">1</span>], O_RDONLY);</span><br><span class="line">  <span class="keyword">if</span> (fd &lt; <span class="number">0</span>) &#123; <span class="keyword">return</span> <span class="number">1</span>; &#125;</span><br><span class="line"></span><br><span class="line">  len = lseek(fd, <span class="number">0</span>, SEEK_END);</span><br><span class="line">  <span class="keyword">if</span> (len &lt; <span class="number">0</span>) &#123; <span class="keyword">return</span> <span class="number">1</span>; &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (lseek(fd, <span class="number">0</span>, SEEK_SET) != <span class="number">0</span>) &#123; <span class="keyword">return</span> <span class="number">1</span>; &#125;</span><br><span class="line"></span><br><span class="line">  buf = <span class="built_in">malloc</span>(len);</span><br><span class="line">  <span class="keyword">if</span> (buf == <span class="literal">NULL</span>) &#123; <span class="keyword">return</span> <span class="number">1</span>; &#125;</span><br><span class="line"></span><br><span class="line">  n_read = read(fd, buf, len);</span><br><span class="line">  <span class="keyword">if</span> (n_read != len) &#123; <span class="keyword">return</span> <span class="number">1</span>; &#125;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Running:    %s: (%zd bytes)\n&quot;</span>, argv[<span class="number">1</span>], n_read);</span><br><span class="line"></span><br><span class="line">  LLVMFuzzerTestOneInput(buf, len);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Done:    %s: (%zd bytes)\n&quot;</span>, argv[<span class="number">1</span>], n_read);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>在以上的测试代码中，有多个函数会成为Fuzz的障碍，在如下的例子中，我们示范如何使用FRIDA的功能修改掉这些障碍。</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Afl</span>.<span class="title function_">print</span>(<span class="string">&#x27;******************&#x27;</span>);</span><br><span class="line"><span class="title class_">Afl</span>.<span class="title function_">print</span>(<span class="string">&#x27;* AFL FRIDA MODE *&#x27;</span>);</span><br><span class="line"><span class="title class_">Afl</span>.<span class="title function_">print</span>(<span class="string">&#x27;******************&#x27;</span>);</span><br><span class="line"><span class="title class_">Afl</span>.<span class="title function_">print</span>(<span class="string">&#x27;&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> main = <span class="title class_">DebugSymbol</span>.<span class="title function_">fromName</span>(<span class="string">&#x27;main&#x27;</span>).<span class="property">address</span>;</span><br><span class="line"><span class="title class_">Afl</span>.<span class="title function_">print</span>(<span class="string">`main: <span class="subst">$&#123;main&#125;</span>`</span>);</span><br><span class="line"><span class="title class_">Afl</span>.<span class="title function_">setEntryPoint</span>(main);</span><br><span class="line"><span class="title class_">Afl</span>.<span class="title function_">setPersistentAddress</span>(main);</span><br><span class="line"><span class="title class_">Afl</span>.<span class="title function_">setPersistentCount</span>(<span class="number">10000000</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> crc32_check = <span class="title class_">DebugSymbol</span>.<span class="title function_">fromName</span>(<span class="string">&#x27;crc32_check&#x27;</span>).<span class="property">address</span>;</span><br><span class="line"><span class="keyword">const</span> crc32_replacement = <span class="keyword">new</span> <span class="title class_">NativeCallback</span>(</span><br><span class="line">    <span class="function">(<span class="params">buf, len</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="title class_">Afl</span>.<span class="title function_">print</span>(<span class="string">`len: <span class="subst">$&#123;len&#125;</span>`</span>);</span><br><span class="line">        <span class="keyword">if</span> (len &lt; <span class="number">4</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">&#x27;int&#x27;</span>,</span><br><span class="line">    [<span class="string">&#x27;pointer&#x27;</span>, <span class="string">&#x27;int&#x27;</span>]);</span><br><span class="line"><span class="title class_">Interceptor</span>.<span class="title function_">replace</span>(crc32_check, crc32_replacement);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> some_boring_bug = <span class="title class_">DebugSymbol</span>.<span class="title function_">fromName</span>(<span class="string">&#x27;some_boring_bug&#x27;</span>).<span class="property">address</span></span><br><span class="line"><span class="keyword">const</span> boring_replacement = <span class="keyword">new</span> <span class="title class_">NativeCallback</span>(</span><br><span class="line">    <span class="function">(<span class="params">c</span>) =&gt;</span> &#123; &#125;,</span><br><span class="line">    <span class="string">&#x27;void&#x27;</span>,</span><br><span class="line">    [<span class="string">&#x27;char&#x27;</span>]);</span><br><span class="line"><span class="title class_">Interceptor</span>.<span class="title function_">replace</span>(some_boring_bug, boring_replacement);</span><br><span class="line"></span><br><span class="line"><span class="title class_">Afl</span>.<span class="title function_">done</span>();</span><br><span class="line"><span class="title class_">Afl</span>.<span class="title function_">print</span>(<span class="string">&quot;done&quot;</span>);</span><br></pre></td></tr></table></figure><h2 id="advanced-patching"><a class="markdownIt-Anchor" href="#advanced-patching"></a> Advanced patching</h2><p>Consider the following code fragment…</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">extern</span> <span class="type">void</span> <span class="title function_">some_boring_bug2</span><span class="params">(<span class="type">char</span> c)</span>;</span><br><span class="line"></span><br><span class="line">__asm__ (</span><br><span class="line">      <span class="string">&quot;.text                                 \n&quot;</span></span><br><span class="line">      <span class="string">&quot;some_boring_bug2:                     \n&quot;</span></span><br><span class="line">      <span class="string">&quot;.global some_boring_bug2              \n&quot;</span></span><br><span class="line">      <span class="string">&quot;.type some_boring_bug2, @function     \n&quot;</span></span><br><span class="line">      <span class="string">&quot;mov %edi, %eax                        \n&quot;</span></span><br><span class="line">      <span class="string">&quot;cmp $0xb4, %al                        \n&quot;</span></span><br><span class="line">      <span class="string">&quot;jne ok                                \n&quot;</span></span><br><span class="line">      <span class="string">&quot;ud2                                   \n&quot;</span></span><br><span class="line">      <span class="string">&quot;ok:                                   \n&quot;</span></span><br><span class="line">      <span class="string">&quot;ret                                   \n&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">LLVMFuzzerTestOneInput</span><span class="params">(<span class="type">char</span> *buf, <span class="type">int</span> len)</span> &#123;</span><br><span class="line"></span><br><span class="line">  ...</span><br><span class="line"></span><br><span class="line">  some_boring_bug2(buf[<span class="number">0</span>]);</span><br><span class="line"></span><br><span class="line">  ...</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>FRIDA除<code>Interceptor.replace</code>和<code>Interceptor.attach</code>API之外，还允许使用<code>Stalker</code>API对目标程序进行更细粒度的更改。</p><p>如下的例子将目标函数中的<code>UD2</code>指令修改为<code>nop</code>指令，从而避免崩溃（<code>UD2</code>指令为崩溃指令）。</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Modify the instructions */</span></span><br><span class="line"><span class="keyword">const</span> some_boring_bug2 = <span class="title class_">DebugSymbol</span>.<span class="title function_">fromName</span>(<span class="string">&#x27;some_boring_bug2&#x27;</span>).<span class="property">address</span></span><br><span class="line"><span class="keyword">const</span> pid = <span class="title class_">Memory</span>.<span class="title function_">alloc</span>(<span class="number">4</span>);</span><br><span class="line">pid.<span class="title function_">writeInt</span>(<span class="title class_">Process</span>.<span class="property">id</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> cm = <span class="keyword">new</span> <span class="title class_">CModule</span>(<span class="string">`</span></span><br><span class="line"><span class="string">    #include &lt;stdio.h&gt;</span></span><br><span class="line"><span class="string">    #include &lt;gum/gumstalker.h&gt;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    typedef int pid_t;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    #define STDERR_FILENO 2</span></span><br><span class="line"><span class="string">    #define BORING2_LEN 10</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    extern int dprintf(int fd, const char *format, ...);</span></span><br><span class="line"><span class="string">    extern void some_boring_bug2(char c);</span></span><br><span class="line"><span class="string">    extern pid_t getpid(void);</span></span><br><span class="line"><span class="string">    extern pid_t pid;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    gboolean js_stalker_callback(const cs_insn *insn, gboolean begin,</span></span><br><span class="line"><span class="string">        gboolean excluded, GumStalkerOutput *output)</span></span><br><span class="line"><span class="string">    &#123;</span></span><br><span class="line"><span class="string">        pid_t my_pid = getpid();</span></span><br><span class="line"><span class="string">        GumX86Writer *cw = output-&gt;writer.x86;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        if (GUM_ADDRESS(insn-&gt;address) &lt; GUM_ADDRESS(some_boring_bug2)) &#123;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">            return TRUE;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        if (GUM_ADDRESS(insn-&gt;address) &gt;=</span></span><br><span class="line"><span class="string">            GUM_ADDRESS(some_boring_bug2) + BORING2_LEN) &#123;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">            return TRUE;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        if (my_pid == pid) &#123;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">            if (begin) &#123;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">                dprintf(STDERR_FILENO, &quot;\n&gt; 0x%016lX: %s %s\n&quot;, insn-&gt;address,</span></span><br><span class="line"><span class="string">                        insn-&gt;mnemonic, insn-&gt;op_str);</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">            &#125; else &#123;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">                dprintf(STDERR_FILENO, &quot;  0x%016lX: %s %s\n&quot;, insn-&gt;address,</span></span><br><span class="line"><span class="string">                        insn-&gt;mnemonic, insn-&gt;op_str);</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">            &#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        if (insn-&gt;id == X86_INS_UD2) &#123;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">            gum_x86_writer_put_nop(cw);</span></span><br><span class="line"><span class="string">            return FALSE;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        &#125; else &#123;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">            return TRUE;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">    `</span>,</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="attr">dprintf</span>: <span class="title class_">Module</span>.<span class="title function_">getExportByName</span>(<span class="literal">null</span>, <span class="string">&#x27;dprintf&#x27;</span>),</span><br><span class="line">        <span class="attr">getpid</span>: <span class="title class_">Module</span>.<span class="title function_">getExportByName</span>(<span class="literal">null</span>, <span class="string">&#x27;getpid&#x27;</span>),</span><br><span class="line">        <span class="attr">some_boring_bug2</span>: some_boring_bug2,</span><br><span class="line">        <span class="attr">pid</span>: pid</span><br><span class="line">    &#125;);</span><br><span class="line"><span class="title class_">Afl</span>.<span class="title function_">setStalkerCallback</span>(cm.<span class="property">js_stalker_callback</span>)</span><br><span class="line"><span class="title class_">Afl</span>.<span class="title function_">setStdErr</span>(<span class="string">&quot;/tmp/stderr.txt&quot;</span>);</span><br></pre></td></tr></table></figure><p>注意你可能更喜欢用如下的代码找到patch地址。</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="variable language_">module</span> = <span class="title class_">Process</span>.<span class="title function_">getModuleByName</span>(<span class="string">&#x27;target.exe&#x27;</span>);</span><br><span class="line"><span class="comment">/* Hardcoded offset within the target image */</span></span><br><span class="line"><span class="keyword">const</span> address = <span class="variable language_">module</span>.<span class="property">base</span>.<span class="title function_">add</span>(<span class="number">0xdeadface</span>);</span><br></pre></td></tr></table></figure><p>OR</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">const address = DebugSymbol.fromName(&quot;my_function&quot;).address.add(0xdeadface);</span><br></pre></td></tr></table></figure><p>OR</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">const address = Module.getExportByName(null, &quot;my_function&quot;).add(0xdeadface);</span><br></pre></td></tr></table></figure><p>若原函数的原始指令没有更更改，则函数<code>js_stalker_callback</code>应该返回<code>TRUE</code>,否则返回<code>FALSE</code>。在上述的例子中，我们可以看到原始指令被替换成<code>NOP</code>指令。</p><p>最后注意：应保持forkserver父子进程的代码相同或forkserver每次产生的子进程代码相同，否则会产生难以调试的bug【原文：<br>note that the same callback will be called when compiling instrumented<br>code both in the child of the forkserver (as it is executed) and also in the<br>parent of the forkserver (when prefetching is enabled) so that it can be<br>inherited by the next forked child. It is <strong>VERY</strong> important that the same<br>instructions be generated in both the parent and the child or if prefetching is<br>disabled that the same instructions are generated every time the block is<br>compiled. Failure to do so will likely lead to bugs which are incredibly<br>difficult to diagnose. The code above only prints the instructions when running<br>in the parent process (the one provided by <code>Process.id</code> when the JS script is<br>executed).】</p><h2 id="osx"><a class="markdownIt-Anchor" href="#osx"></a> OSX</h2><p>注意OSX上JavaScript的调试符号api使用<code>CoreSymbolication</code>API，因此目标进程需要加载和使用<code>CoreFoundation</code>模块，如下设定：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">AFL_PRELOAD=/System/Library/Frameworks/CoreFoundation.framework/CoreFoundation</span><br></pre></td></tr></table></figure><p>应该被注意的是<code>CoreSymbolication</code>API在初始化和创建cache的时候较慢，因此，需要增加<code>afl-fuzz</code>的<code>-t</code>参数的值，避免超时。</p><h2 id="api"><a class="markdownIt-Anchor" href="#api"></a> API</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Afl</span> &#123;</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * This is equivalent to setting a value in `AFL_FRIDA_EXCLUDE_RANGES`,</span></span><br><span class="line"><span class="comment">   * it takes as arguments a `NativePointer` and a `number`. It can be</span></span><br><span class="line"><span class="comment">   * called multiple times to exclude several ranges.</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">static</span> <span class="title function_">addExcludedRange</span>(<span class="params">addressess, size</span>) &#123;</span><br><span class="line">      <span class="title class_">Afl</span>.<span class="title function_">jsApiAddExcludeRange</span>(addressess, size);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * This is equivalent to setting a value in `AFL_FRIDA_INST_RANGES`,</span></span><br><span class="line"><span class="comment">   * it takes as arguments a `NativePointer` and a `number`. It can be</span></span><br><span class="line"><span class="comment">   * called multiple times to include several ranges.</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">static</span> <span class="title function_">addIncludedRange</span>(<span class="params">addressess, size</span>) &#123;</span><br><span class="line">      <span class="title class_">Afl</span>.<span class="title function_">jsApiAddIncludeRange</span>(addressess, size);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * This must always be called at the end of your script. This lets</span></span><br><span class="line"><span class="comment">   * FRIDA mode know that your configuration is finished and that</span></span><br><span class="line"><span class="comment">   * execution has reached the end of your script. Failure to call</span></span><br><span class="line"><span class="comment">   * this will result in a fatal error.</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">static</span> <span class="title function_">done</span>(<span class="params"></span>) &#123;</span><br><span class="line">      <span class="title class_">Afl</span>.<span class="title function_">jsApiDone</span>();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * This function can be called within your script to cause FRIDA</span></span><br><span class="line"><span class="comment">   * mode to trigger a fatal error. This is useful if for example you</span></span><br><span class="line"><span class="comment">   * discover a problem you weren&#x27;t expecting and want everything to</span></span><br><span class="line"><span class="comment">   * stop. The user will need to enable `AFL_DEBUG_CHILD=1` to view</span></span><br><span class="line"><span class="comment">   * this error message.</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">static</span> <span class="title function_">error</span>(<span class="params">msg</span>) &#123;</span><br><span class="line">      <span class="keyword">const</span> buf = <span class="title class_">Memory</span>.<span class="title function_">allocUtf8String</span>(msg);</span><br><span class="line">      <span class="title class_">Afl</span>.<span class="title function_">jsApiError</span>(buf);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * Function used to provide access to `__afl_fuzz_ptr`, which contains the length of</span></span><br><span class="line"><span class="comment">   * fuzzing data when using in-memory test case fuzzing.</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">static</span> <span class="title function_">getAflFuzzLen</span>(<span class="params"></span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="title class_">Afl</span>.<span class="title function_">jsApiGetSymbol</span>(<span class="string">&quot;__afl_fuzz_len&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * Function used to provide access to `__afl_fuzz_ptr`, which contains the fuzzing</span></span><br><span class="line"><span class="comment">   * data when using in-memory test case fuzzing.</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">static</span> <span class="title function_">getAflFuzzPtr</span>(<span class="params"></span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="title class_">Afl</span>.<span class="title function_">jsApiGetSymbol</span>(<span class="string">&quot;__afl_fuzz_ptr&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * Print a message to the STDOUT. This should be preferred to</span></span><br><span class="line"><span class="comment">   * FRIDA&#x27;s `console.log` since FRIDA will queue it&#x27;s log messages.</span></span><br><span class="line"><span class="comment">   * If `console.log` is used in a callback in particular, then there</span></span><br><span class="line"><span class="comment">   * may no longer be a thread running to service this queue.</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">static</span> <span class="title function_">print</span>(<span class="params">msg</span>) &#123;</span><br><span class="line">      <span class="keyword">const</span> <span class="variable constant_">STDOUT_FILENO</span> = <span class="number">2</span>;</span><br><span class="line">      <span class="keyword">const</span> log = <span class="string">`<span class="subst">$&#123;msg&#125;</span>\n`</span>;</span><br><span class="line">      <span class="keyword">const</span> buf = <span class="title class_">Memory</span>.<span class="title function_">allocUtf8String</span>(log);</span><br><span class="line">      <span class="title class_">Afl</span>.<span class="title function_">jsApiWrite</span>(<span class="variable constant_">STDOUT_FILENO</span>, buf, log.<span class="property">length</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * See `AFL_FRIDA_STALKER_NO_BACKPATCH`.</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">static</span> <span class="title function_">setBackpatchDisable</span>(<span class="params"></span>) &#123;</span><br><span class="line">      <span class="title class_">Afl</span>.<span class="title function_">jsApiSetBackpatchDisable</span>();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * See `AFL_FRIDA_DEBUG_MAPS`.</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">static</span> <span class="title function_">setDebugMaps</span>(<span class="params"></span>) &#123;</span><br><span class="line">      <span class="title class_">Afl</span>.<span class="title function_">jsApiSetDebugMaps</span>();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * This has the same effect as setting `AFL_ENTRYPOINT`, but has the</span></span><br><span class="line"><span class="comment">   * convenience of allowing you to use FRIDAs APIs to determine the</span></span><br><span class="line"><span class="comment">   * address you would like to configure, rather than having to grep</span></span><br><span class="line"><span class="comment">   * the output of `readelf` or something similarly ugly. This</span></span><br><span class="line"><span class="comment">   * function should be called with a `NativePointer` as its</span></span><br><span class="line"><span class="comment">   * argument.</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">static</span> <span class="title function_">setEntryPoint</span>(<span class="params">address</span>) &#123;</span><br><span class="line">      <span class="title class_">Afl</span>.<span class="title function_">jsApiSetEntryPoint</span>(address);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * Function used to enable in-memory test cases for fuzzing.</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">static</span> <span class="title function_">setInMemoryFuzzing</span>(<span class="params"></span>) &#123;</span><br><span class="line">      <span class="title class_">Afl</span>.<span class="property">jsApiAflSharedMemFuzzing</span>.<span class="title function_">writeInt</span>(<span class="number">1</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * See `AFL_FRIDA_INST_COVERAGE_FILE`. This function takes a single `string`</span></span><br><span class="line"><span class="comment">   * as an argument.</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">static</span> <span class="title function_">setInstrumentCoverageFile</span>(<span class="params">file</span>) &#123;</span><br><span class="line">      <span class="keyword">const</span> buf = <span class="title class_">Memory</span>.<span class="title function_">allocUtf8String</span>(file);</span><br><span class="line">      <span class="title class_">Afl</span>.<span class="title function_">jsApiSetInstrumentCoverageFile</span>(buf);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * See `AFL_FRIDA_INST_DEBUG_FILE`. This function takes a single `string` as</span></span><br><span class="line"><span class="comment">   * an argument.</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">static</span> <span class="title function_">setInstrumentDebugFile</span>(<span class="params">file</span>) &#123;</span><br><span class="line">      <span class="keyword">const</span> buf = <span class="title class_">Memory</span>.<span class="title function_">allocUtf8String</span>(file);</span><br><span class="line">      <span class="title class_">Afl</span>.<span class="title function_">jsApiSetInstrumentDebugFile</span>(buf);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * See `AFL_FRIDA_INST_TRACE`.</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">static</span> <span class="title function_">setInstrumentEnableTracing</span>(<span class="params"></span>) &#123;</span><br><span class="line">      <span class="title class_">Afl</span>.<span class="title function_">jsApiSetInstrumentTrace</span>();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * See `AFL_FRIDA_INST_JIT`.</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">static</span> <span class="title function_">setInstrumentJit</span>(<span class="params"></span>) &#123;</span><br><span class="line">      <span class="title class_">Afl</span>.<span class="title function_">jsApiSetInstrumentJit</span>();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * See `AFL_INST_LIBS`.</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">static</span> <span class="title function_">setInstrumentLibraries</span>(<span class="params"></span>) &#123;</span><br><span class="line">      <span class="title class_">Afl</span>.<span class="title function_">jsApiSetInstrumentLibraries</span>();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * See `AFL_FRIDA_INST_NO_OPTIMIZE`</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">static</span> <span class="title function_">setInstrumentNoOptimize</span>(<span class="params"></span>) &#123;</span><br><span class="line">      <span class="title class_">Afl</span>.<span class="title function_">jsApiSetInstrumentNoOptimize</span>();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">    * See `AFL_FRIDA_INST_SEED`</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">  <span class="keyword">static</span> <span class="title function_">setInstrumentSeed</span>(<span class="params">seed</span>) &#123;</span><br><span class="line">      <span class="title class_">Afl</span>.<span class="title function_">jsApiSetInstrumentSeed</span>(seed);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * See `AFL_FRIDA_INST_TRACE_UNIQUE`.</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">static</span> <span class="title function_">setInstrumentTracingUnique</span>(<span class="params"></span>) &#123;</span><br><span class="line">      <span class="title class_">Afl</span>.<span class="title function_">jsApiSetInstrumentTraceUnique</span>();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * See `AFL_FRIDA_INST_UNSTABLE_COVERAGE_FILE`. This function takes a single</span></span><br><span class="line"><span class="comment">   * `string` as an argument.</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">static</span> <span class="title function_">setInstrumentUnstableCoverageFile</span>(<span class="params">file</span>) &#123;</span><br><span class="line">      <span class="keyword">const</span> buf = <span class="title class_">Memory</span>.<span class="title function_">allocUtf8String</span>(file);</span><br><span class="line">      <span class="title class_">Afl</span>.<span class="title function_">jsApiSetInstrumentUnstableCoverageFile</span>(buf);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">    * Set a callback to be called in place of the usual `main` function. This see</span></span><br><span class="line"><span class="comment">    * `Scripting.md` for details.</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">  <span class="keyword">static</span> <span class="title function_">setJsMainHook</span>(<span class="params">address</span>) &#123;</span><br><span class="line">      <span class="title class_">Afl</span>.<span class="title function_">jsApiSetJsMainHook</span>(address);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * This is equivalent to setting `AFL_FRIDA_PERSISTENT_ADDR`, again a</span></span><br><span class="line"><span class="comment">   * `NativePointer` should be provided as it&#x27;s argument.</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">static</span> <span class="title function_">setPersistentAddress</span>(<span class="params">address</span>) &#123;</span><br><span class="line">      <span class="title class_">Afl</span>.<span class="title function_">jsApiSetPersistentAddress</span>(address);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * This is equivalent to setting `AFL_FRIDA_PERSISTENT_CNT`, a</span></span><br><span class="line"><span class="comment">   * `number` should be provided as it&#x27;s argument.</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">static</span> <span class="title function_">setPersistentCount</span>(<span class="params">count</span>) &#123;</span><br><span class="line">      <span class="title class_">Afl</span>.<span class="title function_">jsApiSetPersistentCount</span>(count);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * See `AFL_FRIDA_PERSISTENT_DEBUG`.</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">static</span> <span class="title function_">setPersistentDebug</span>(<span class="params"></span>) &#123;</span><br><span class="line">      <span class="title class_">Afl</span>.<span class="title function_">jsApiSetPersistentDebug</span>();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * See `AFL_FRIDA_PERSISTENT_ADDR`. This function takes a NativePointer as an</span></span><br><span class="line"><span class="comment">   * argument. See above for examples of use.</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">static</span> <span class="title function_">setPersistentHook</span>(<span class="params">address</span>) &#123;</span><br><span class="line">      <span class="title class_">Afl</span>.<span class="title function_">jsApiSetPersistentHook</span>(address);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * This is equivalent to setting `AFL_FRIDA_PERSISTENT_RET`, again a</span></span><br><span class="line"><span class="comment">   * `NativePointer` should be provided as it&#x27;s argument.</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">static</span> <span class="title function_">setPersistentReturn</span>(<span class="params">address</span>) &#123;</span><br><span class="line">      <span class="title class_">Afl</span>.<span class="title function_">jsApiSetPersistentReturn</span>(address);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * See `AFL_FRIDA_INST_NO_PREFETCH_BACKPATCH`.</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">static</span> <span class="title function_">setPrefetchBackpatchDisable</span>(<span class="params"></span>) &#123;</span><br><span class="line">      <span class="title class_">Afl</span>.<span class="title function_">jsApiSetPrefetchBackpatchDisable</span>();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * See `AFL_FRIDA_INST_NO_PREFETCH`.</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">static</span> <span class="title function_">setPrefetchDisable</span>(<span class="params"></span>) &#123;</span><br><span class="line">      <span class="title class_">Afl</span>.<span class="title function_">jsApiSetPrefetchDisable</span>();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * See `AFL_FRIDA_SECCOMP_FILE`. This function takes a single `string` as</span></span><br><span class="line"><span class="comment">   * an argument.</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">static</span> <span class="title function_">setSeccompFile</span>(<span class="params">file</span>) &#123;</span><br><span class="line">      <span class="keyword">const</span> buf = <span class="title class_">Memory</span>.<span class="title function_">allocUtf8String</span>(file);</span><br><span class="line">      <span class="title class_">Afl</span>.<span class="title function_">jsApiSetSeccompFile</span>(buf);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * See `AFL_FRIDA_STALKER_ADJACENT_BLOCKS`.</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">static</span> <span class="title function_">setStalkerAdjacentBlocks</span>(<span class="params">val</span>) &#123;</span><br><span class="line">      <span class="title class_">Afl</span>.<span class="title function_">jsApiSetStalkerAdjacentBlocks</span>(val);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">    * Set a function to be called for each instruction which is instrumented</span></span><br><span class="line"><span class="comment">    * by AFL FRIDA mode.</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">  <span class="keyword">static</span> <span class="title function_">setStalkerCallback</span>(<span class="params">callback</span>) &#123;</span><br><span class="line">      <span class="title class_">Afl</span>.<span class="title function_">jsApiSetStalkerCallback</span>(callback);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * See `AFL_FRIDA_STALKER_IC_ENTRIES`.</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">static</span> <span class="title function_">setStalkerIcEntries</span>(<span class="params">val</span>) &#123;</span><br><span class="line">      <span class="title class_">Afl</span>.<span class="title function_">jsApiSetStalkerIcEntries</span>(val);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * See `AFL_FRIDA_STATS_FILE`. This function takes a single `string` as</span></span><br><span class="line"><span class="comment">   * an argument.</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">static</span> <span class="title function_">setStatsFile</span>(<span class="params">file</span>) &#123;</span><br><span class="line">      <span class="keyword">const</span> buf = <span class="title class_">Memory</span>.<span class="title function_">allocUtf8String</span>(file);</span><br><span class="line">      <span class="title class_">Afl</span>.<span class="title function_">jsApiSetStatsFile</span>(buf);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * See `AFL_FRIDA_STATS_INTERVAL`. This function takes a `number` as an</span></span><br><span class="line"><span class="comment">   * argument</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">static</span> <span class="title function_">setStatsInterval</span>(<span class="params">interval</span>) &#123;</span><br><span class="line">      <span class="title class_">Afl</span>.<span class="title function_">jsApiSetStatsInterval</span>(interval);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * See `AFL_FRIDA_OUTPUT_STDERR`. This function takes a single `string` as</span></span><br><span class="line"><span class="comment">   * an argument.</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">static</span> <span class="title function_">setStdErr</span>(<span class="params">file</span>) &#123;</span><br><span class="line">      <span class="keyword">const</span> buf = <span class="title class_">Memory</span>.<span class="title function_">allocUtf8String</span>(file);</span><br><span class="line">      <span class="title class_">Afl</span>.<span class="title function_">jsApiSetStdErr</span>(buf);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * See `AFL_FRIDA_OUTPUT_STDOUT`. This function takes a single `string` as</span></span><br><span class="line"><span class="comment">   * an argument.</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">static</span> <span class="title function_">setStdOut</span>(<span class="params">file</span>) &#123;</span><br><span class="line">      <span class="keyword">const</span> buf = <span class="title class_">Memory</span>.<span class="title function_">allocUtf8String</span>(file);</span><br><span class="line">      <span class="title class_">Afl</span>.<span class="title function_">jsApiSetStdOut</span>(buf);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * See `AFL_FRIDA_TRACEABLE`.</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">static</span> <span class="title function_">setTraceable</span>(<span class="params"></span>) &#123;</span><br><span class="line">      <span class="title class_">Afl</span>.<span class="title function_">jsApiSetTraceable</span>();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">static</span> <span class="title function_">jsApiGetFunction</span>(<span class="params">name, retType, argTypes</span>) &#123;</span><br><span class="line">      <span class="keyword">const</span> addr = <span class="title class_">Afl</span>.<span class="property">module</span>.<span class="title function_">getExportByName</span>(name);</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">NativeFunction</span>(addr, retType, argTypes);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">static</span> <span class="title function_">jsApiGetSymbol</span>(<span class="params">name</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="title class_">Afl</span>.<span class="property">module</span>.<span class="title function_">getExportByName</span>(name);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><div class="article-footer"><blockquote class="mt-2x"><ul class="post-copyright list-unstyled"><li class="post-copyright-link hidden-xs"><strong>本文链接：</strong> <a href="http://www.4x7.fun/2022/04/05/AFL-Frida-Mode-Scripting/" title="AFL++ Frida-Mode Scripting" target="_blank" rel="external">http://www.4x7.fun/2022/04/05/AFL-Frida-Mode-Scripting/</a></li><li class="post-copyright-license"><strong>版权声明： </strong>本博客所有文章除特别声明外，均采用 <a href="http://creativecommons.org/licenses/by/4.0/deed.zh" target="_blank" rel="external">CC BY 4.0 CN协议</a> 许可协议。转载请注明出处！</li></ul></blockquote><div class="panel panel-default panel-badger"><div class="panel-body"><figure class="media"><div class="media-left"><a href="https://www.4x7.fun" target="_blank" class="img-burn thumb-sm visible-lg"><img src="/images/avatar.jpg" class="img-rounded w-full" alt=""></a></div><div class="media-body"><h3 class="media-heading"><a href="https://www.4x7.fun" target="_blank"><span class="text-dark">大和尚</span><small class="ml-1x">Developer &amp; Security</small></a></h3><div>老码农</div></div></figure></div></div></div></article><section id="comments"><div id="vcomments"></div></section></div><nav class="bar bar-footer clearfix" data-stick-bottom><div class="bar-inner"><ul class="pager pull-left"><li class="prev"><a href="/2022/04/07/AFL-Frida-Mode-Usecases-for-testing-and-debugging/" title="AFL++ Frida-Mode: Usecases for testing and debugging"><i class="icon icon-angle-left" aria-hidden="true"></i><span>&nbsp;&nbsp;Newer</span></a></li><li class="next"><a href="/2022/03/25/HeapAttack-House-of-Orange/" title="HeapAttack: House_of_Orange"><span>Older&nbsp;&nbsp;</span><i class="icon icon-angle-right" aria-hidden="true"></i></a></li></ul><div class="bar-right"><div class="share-component" data-sites="weibo,qq,wechat,facebook,twitter" data-mobile-sites="weibo,qq,qzone"></div></div></div></nav></main><footer class="footer" itemscope itemtype="http://schema.org/WPFooter"><ul class="social-links"><li><a href="https://twitter.com/hl4x7eq28" target="_blank" title="Twitter" data-toggle="tooltip" data-placement="top"><i class="icon icon-twitter"></i></a></li><li><a href="/atom.xml" target="_blank" title="Rss" data-toggle="tooltip" data-placement="top"><i class="icon icon-rss"></i></a></li></ul><div class="copyright"><div class="publishby">Theme by <a href="https://github.com/cofess" target="_blank">cofess </a>base on <a href="https://github.com/cofess/hexo-theme-pure" target="_blank">pure</a>.</div></div></footer><script src="//cdn.jsdelivr.net/npm/jquery@1.12.4/dist/jquery.min.js"></script><script>window.jQuery||document.write('<script src="js/jquery.min.js"><\/script>')</script><script src="/js/plugin.min.js"></script><script src="/js/application.js"></script><script>window.INSIGHT_CONFIG={TRANSLATION:{POSTS:"Posts",PAGES:"Pages",CATEGORIES:"Categories",TAGS:"Tags",UNTITLED:"(Untitled)"},ROOT_URL:"/",CONTENT_URL:"/content.json"}</script><script src="/js/insight.js"></script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script><script src="//cdn.jsdelivr.net/npm/valine"></script><script type="text/javascript">var GUEST=["nick","mail","link"],meta=(meta="nick,mail,link").split(",").filter(function(e){return-1<GUEST.indexOf(e)});new Valine({el:"#vcomments",verify:!1,notify:!1,appId:"",appKey:"",placeholder:"Just go go",avatar:"mm",meta:meta,pageSize:"10",visitor:!1})</script></body></html>